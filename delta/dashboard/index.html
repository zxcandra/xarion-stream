<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DeltaMusic Statistics</title>

    <!-- PWA -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#efeff4">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <link rel="apple-touch-icon" href="https://img.icons8.com/fluency/192/musical-notes.png">

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --tg-theme-bg-color: #ffffff;
            --tg-theme-text-color: #000000;
            --tg-theme-hint-color: #8e8e93;
            --tg-theme-link-color: #007aff;
            --tg-theme-button-color: #007aff;
            --tg-theme-button-text-color: #ffffff;
            --tg-theme-secondary-bg-color: #efeff4;
            --tg-theme-header-bg-color: #efeff4;
        }

        body.dark-theme {
            --tg-theme-bg-color: #1c1c1e;
            --tg-theme-text-color: #ffffff;
            --tg-theme-secondary-bg-color: #000000;
            --tg-theme-hint-color: #98989d;
            --tg-theme-button-color: #0a84ff;
            --tg-theme-header-bg-color: #000000;
            --tg-theme-button-text-color: #ffffff;
        }

        .theme-toggle {
            position: fixed;
            top: 24px;
            right: 24px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border: none;
            cursor: pointer;
            z-index: 100;
            transition: all 0.3s ease;
        }

        .theme-toggle:hover {
            transform: scale(1.1);
        }

        .theme-toggle svg {
            width: 20px;
            height: 20px;
            transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .theme-toggle.rotating svg {
            transform: rotate(180deg);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--tg-theme-secondary-bg-color, #efeff4);
            color: var(--tg-theme-text-color, #000000);
            margin: 0;
            padding: 0;
            -webkit-font-smoothing: antialiased;
            padding-bottom: 40px;
            /* Space for FAB */
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 0 16px;
        }

        /* Header */
        .header {
            text-align: center;
            padding: 24px 0 16px;
        }

        .header h1 {
            font-size: 28px;
            font-weight: 700;
            margin: 0 0 4px;
            letter-spacing: -0.5px;
        }

        .header p {
            color: var(--tg-theme-hint-color, #8e8e93);
            font-size: 15px;
            margin: 0;
        }

        /* Section Titles (iOS Grouped Header Style) */
        .section-title {
            font-size: 13px;
            text-transform: uppercase;
            color: var(--tg-theme-hint-color, #8e8e93);
            margin: 24px 0 8px 16px;
            letter-spacing: -0.1px;
        }

        /* Grouped Cards */
        .card {
            background-color: var(--tg-theme-bg-color, #ffffff);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 24px;
        }

        /* Overview Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            border-radius: 10px;
            overflow: hidden;
            background-color: var(--tg-theme-bg-color, #ffffff);
            margin-bottom: 24px;
        }

        @media (min-width: 600px) {
            .stats-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        .stat-item {
            padding: 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            position: relative;
        }

        /* Grid separators */
        .stat-item::after {
            content: '';
            position: absolute;
            right: 0;
            top: 15%;
            bottom: 15%;
            width: 1px;
            background-color: var(--tg-theme-secondary-bg-color, #efeff4);
        }

        .stat-item:nth-child(2n)::after {
            display: none;
        }

        @media (min-width: 600px) {
            .stat-item::after {
                display: block;
            }

            .stat-item:last-child::after {
                display: none;
            }
        }

        .stat-item:active {
            background-color: var(--tg-theme-secondary-bg-color, #efeff4);
        }

        .stat-value {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 4px;
            color: var(--tg-theme-text-color);
        }

        .stat-label {
            font-size: 13px;
            color: var(--tg-theme-hint-color, #8e8e93);
        }

        /* List Items */
        .list-row {
            display: flex;
            align-items: center;
            padding: 11px 16px;
            background-color: var(--tg-theme-bg-color, #ffffff);
            position: relative;
            min-height: 48px;
        }

        .list-row:active {
            background-color: var(--tg-theme-secondary-bg-color, #efeff4);
        }

        /* Separator Line */
        .list-row:not(:last-child)::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 72px;
            /* Adjusted for image + rank */
            right: 0;
            height: 1px;
            background-color: var(--tg-theme-secondary-bg-color, #effef4);
            /* Fallback for separator color if variable not distinctive enough implies using opacity */
            background-color: rgba(128, 128, 128, 0.2);
        }

        .list-row.no-image::after {
            left: 56px;
        }

        .rank-circle {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background-color: var(--tg-theme-secondary-bg-color, #efeff4);
            color: var(--tg-theme-hint-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 11px;
            margin-right: 12px;
            flex-shrink: 0;
        }

        /* Top 3 Colors (Subtle badges for rank) */
        .rank-1 {
            color: #FF9500;
            background: rgba(255, 149, 0, 0.1);
        }

        .rank-2 {
            color: #8E8E93;
            background: rgba(142, 142, 147, 0.1);
        }

        .rank-3 {
            color: #AF52DE;
            background: rgba(175, 82, 222, 0.1);
        }

        .list-image {
            width: 40px;
            height: 40px;
            background-color: var(--tg-theme-secondary-bg-color, #efeff4);
            margin-right: 12px;
            flex-shrink: 0;
            object-fit: cover;
        }

        .list-image.circle {
            border-radius: 50%;
        }

        .list-image.rounded {
            border-radius: 8px;
        }

        .list-placeholder {
            width: 40px;
            height: 40px;
            background-color: var(--tg-theme-button-color, #007aff);
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 16px;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .list-placeholder.circle {
            border-radius: 50%;
        }

        .list-placeholder.rounded {
            border-radius: 8px;
        }

        .row-content {
            flex: 1;
            min-width: 0;
        }

        .row-title {
            font-size: 16px;
            font-weight: 400;
            /* Apple style is usually regular for list items */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: var(--tg-theme-text-color);
        }

        .row-subtitle {
            font-size: 13px;
            color: var(--tg-theme-hint-color);
            margin-top: 2px;
        }

        .row-value {
            font-size: 15px;
            font-weight: 400;
            color: var(--tg-theme-hint-color);
            /* Value usually secondary color in iOS settings unless highlighted */
            margin-left: 12px;
            flex-shrink: 0;
        }

        /* Chart Container */
        .chart-container {
            padding: 16px;
            height: 240px;
        }

        /* Loading & Error */
        .status-text {
            text-align: center;
            padding: 24px;
            color: var(--tg-theme-hint-color);
            font-size: 14px;
        }

        /* Floating Refresh Button */
        .fab {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background-color: var(--tg-theme-button-color, #007aff);
            color: var(--tg-theme-button-text-color, #ffffff);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            border: none;
            cursor: pointer;
            z-index: 100;
            transition: transform 0.2s;
        }

        .fab:active {
            transform: scale(0.95);
        }

        .spin {
            animation: spin 1s infinite linear;
        }

        .scrollable-card {
            max-height: 400px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        /* Bottom Nav */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 50px;
            /* Reduced specific height */
            background-color: var(--tg-theme-bg-color, #ffffff);
            display: flex;
            justify-content: space-around;
            align-items: center;
            border-top: 1px solid var(--tg-theme-secondary-bg-color, #c8c7cc);
            padding-bottom: env(safe-area-inset-bottom);
            z-index: 1000;
        }

        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            border: none;
            background: none;
            color: var(--tg-theme-hint-color, #8e8e93);
            font-size: 10px;
            cursor: pointer;
            padding: 4px 0;
            -webkit-tap-highlight-color: transparent;
        }

        .nav-item.active {
            color: var(--tg-theme-button-color, #007aff);
        }

        .nav-icon {
            font-size: 20px;
            margin-bottom: 2px;
        }

        .tab-content {
            display: none;
            padding-bottom: 60px;
            /* Space for bottom nav */
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.2s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        /* Adjust body padding */
        body {
            background-color: var(--tg-theme-button-color, #007aff);
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .status-value-text {
            font-size: 14px;
            color: var(--tg-theme-hint-color);
            margin-left: 12px;
            width: 40px;
            text-align: right;
            font-variant-numeric: tabular-nums;
        }

        .server-status-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            padding: 16px;
        }

        @media (max-width: 600px) {
            .server-status-grid {
                grid-template-columns: 1fr;
            }
        }

        .status-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background-color: var(--tg-theme-secondary-bg-color, #efeff4);
            border-radius: 8px;
        }

        .status-label {
            font-size: 13px;
            color: var(--tg-theme-hint-color);
            font-weight: 500;
        }

        .status-right {
            display: flex;
            align-items: center;
        }

        .network-stats {
            display: flex;
            justify-content: space-around;
            padding: 12px 16px;
            background-color: var(--tg-theme-secondary-bg-color, #efeff4);
            border-radius: 8px;
            margin: 12px 16px;
        }

        .network-stat-item {
            text-align: center;
        }

        .network-stat-label {
            font-size: 11px;
            color: var(--tg-theme-hint-color);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .network-stat-value {
            font-size: 16px;
            font-weight: 600;
            color: var(--tg-theme-text-color);
            margin-top: 4px;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>DeltaMusic</h1>
            <p>Statistics Dashboard</p>
        </div>

        <button class="theme-toggle" onclick="toggleTheme()" id="themeBtn">
            <!-- SVG Icons will be injected by JavaScript -->
        </button>

        <!-- Tab 1: Home -->
        <div id="tab-home" class="tab-content active">
            <div class="section-title">Overview</div>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-value" id="totalUsers">-</div>
                    <div class="stat-label">Users</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="totalChats">-</div>
                    <div class="stat-label">Groups</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="totalPlays">-</div>
                    <div class="stat-label">Plays</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="activeCalls">-</div>
                    <div class="stat-label">Calls</div>
                </div>
            </div>

            <div class="section-title">Server Status</div>
            <div class="card">
                <div class="server-status-grid">
                    <div class="status-row">
                        <div class="status-label">CPU</div>
                        <div class="status-right">
                            <div class="status-bar-container">
                                <div class="status-bar-fill" id="cpuBar" style="width: 0%"></div>
                            </div>
                            <div class="status-value-text" id="cpuText">-</div>
                        </div>
                    </div>
                    <div class="status-row">
                        <div class="status-label">RAM</div>
                        <div class="status-right">
                            <div class="status-bar-container">
                                <div class="status-bar-fill" id="ramBar" style="width: 0%"></div>
                            </div>
                            <div class="status-value-text" id="ramText">-</div>
                        </div>
                    </div>
                    <div class="status-row">
                        <div class="status-label">Disk</div>
                        <div class="status-right">
                            <div class="status-bar-container">
                                <div class="status-bar-fill" id="diskBar" style="width: 0%"></div>
                            </div>
                            <div class="status-value-text" id="diskText">-</div>
                        </div>
                    </div>
                    <div class="status-row">
                        <div class="status-label">Uptime</div>
                        <div class="status-value-text" style="width: auto;" id="uptimeText">-</div>
                    </div>
                </div>

                <div class="section-title">Peak Usage (Last 7 Days)</div>
                <div class="card">
                    <div class="chart-container">
                        <canvas id="peakChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Tab 2: Analytics -->
            <div id="tab-analytics" class="tab-content">
                <div class="section-title">Activity Trend</div>
                <div class="card">
                    <div class="chart-container">
                        <canvas id="dailyChart"></canvas>
                    </div>
                </div>

                <div class="section-title">Platform Distribution</div>
                <div class="card">
                    <div class="chart-container">
                        <canvas id="platformChart"></canvas>
                    </div>
                </div>

                <div class="section-title">Network Activity (Real-time)</div>
                <div class="card">
                    <div class="chart-container">
                        <canvas id="networkRealtimeChart"></canvas>
                    </div>
                    <div class="network-stats">
                        <div class="network-stat-item">
                            <div class="network-stat-label">‚Üë Total Upload</div>
                            <div class="network-stat-value" id="totalUpload">-</div>
                        </div>
                        <div class="network-stat-item">
                            <div class="network-stat-label">‚Üì Total Download</div>
                            <div class="network-stat-value" id="totalDownload">-</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab 3: Rankings -->
            <div id="tab-rankings" class="tab-content">
                <div class="section-title">Top Plays</div>
                <div class="card scrollable-card" id="topTracksList">
                    <div class="status-text">Loading...</div>
                </div>

                <div class="section-title">Most Active Users</div>
                <div class="card" id="topUsersList">
                    <div class="status-text">Loading...</div>
                </div>

                <div class="section-title">Top Groups</div>
                <div class="card" id="topChatsList">
                    <div class="status-text">Loading...</div>
                </div>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <button class="nav-item active" onclick="switchTab('home')">
                <div class="nav-icon">üè†</div>
                <div>Home</div>
            </button>
            <button class="nav-item" onclick="switchTab('analytics')">
                <div class="nav-icon">üìä</div>
                <div>Analytics</div>
            </button>
            <button class="nav-item" onclick="switchTab('rankings')">
                <div class="nav-icon">üèÜ</div>
                <div>Rankings</div>
            </button>
        </nav>

        <button class="fab" onclick="loadAllData()">‚Üª</button>


        <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
        <script>
            const API_BASE = window.location.origin;
            let dailyChart = null;
            let tg = window.Telegram.WebApp;

            function switchTab(tabId) {
                // Update Tab Content
                document.querySelectorAll('.tab-content').forEach(el => {
                    el.classList.remove('active');
                });
                document.getElementById(`tab-${tabId}`).classList.add('active');

                // Update Nav Buttons
                document.querySelectorAll('.nav-item').forEach(el => {
                    el.classList.remove('active');
                });
                // Find the button that calls this tab (simple approximation)
                event.currentTarget.classList.add('active'); // Warning: relies on event bubbling, might need cleaner selection

                // Persist
                localStorage.setItem('activeTab', tabId);
            }

            // Init Tab
            const savedTab = localStorage.getItem('activeTab');
            if (savedTab) {
                // We need to manually trigger the switch safely
                // Wait for DOM or just apply classes manually if called early
                // Simple hack: mimic click or just manual class set
                // Let's do manual class set to avoid event issues in init
                const tabEl = document.getElementById(`tab-${savedTab}`);
                if (tabEl) {
                    document.querySelectorAll('.tab-content').forEach(e => e.classList.remove('active'));
                    tabEl.classList.add('active');

                    document.querySelectorAll('.nav-item').forEach(e => {
                        e.classList.remove('active');
                        if (e.getAttribute('onclick').includes(savedTab)) e.classList.add('active');
                    });
                }
            }

            // SVG Icons
            const sunIcon = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><circle cx="12" cy="12" r="4"/><path d="M12 2v2m0 16v2M4.93 4.93l1.41 1.41m11.32 11.32l1.41 1.41M2 12h2m16 0h2M4.93 19.07l1.41-1.41m11.32-11.32l1.41-1.41"/></svg>`;
            const moonIcon = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>`;

            function toggleTheme() {
                const body = document.body;
                const btn = document.getElementById('themeBtn');

                // Add rotation animation
                btn.classList.add('rotating');

                setTimeout(() => {
                    if (body.classList.contains('dark-theme')) {
                        body.classList.remove('dark-theme');
                        btn.innerHTML = moonIcon;
                        localStorage.setItem('theme', 'light');
                    } else {
                        body.classList.add('dark-theme');
                        btn.innerHTML = sunIcon;
                        localStorage.setItem('theme', 'dark');
                    }

                    // Remove rotation class after animation
                    setTimeout(() => btn.classList.remove('rotating'), 500);

                    // Reload chart to update colors
                    loadChart();
                    loadPeakHours();
                    loadPlatformDistribution();
                }, 250);
            }

            function formatBytes(bytes) {
                if (!bytes || bytes === 0) return '0 B';
                const units = ['B', 'KB', 'MB', 'GB', 'TB'];
                const k = 1024;
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return (bytes / Math.pow(k, i)).toFixed(2) + ' ' + units[i];
            }

            async function fetchAPI(endpoint) {
                try {
                    const response = await fetch(`${API_BASE}/api/${endpoint}`);
                    if (!response.ok) throw new Error('API Error');
                    return await response.json();
                } catch (error) {
                    console.error(error);
                    return null;
                }
            }

            function formatNumber(num) {
                return new Intl.NumberFormat('id-ID').format(num);
            }

            async function loadOverview() {
                const data = await fetchAPI('overview');
                if (data) {
                    document.getElementById('totalUsers').textContent = formatNumber(data.total_users);
                    document.getElementById('totalChats').textContent = formatNumber(data.total_chats);
                    document.getElementById('totalPlays').textContent = formatNumber(data.total_plays);
                    document.getElementById('activeCalls').textContent = formatNumber(data.active_calls);
                }
            }

            async function loadChart() {
                const data = await fetchAPI('daily-stats?days=7');
                if (!data) return;

                const ctx = document.getElementById('dailyChart');
                const labels = data.map(d => new Date(d.date).toLocaleDateString('id-ID', { weekday: 'short' }));
                const values = data.map(d => d.play_count);

                if (dailyChart) dailyChart.destroy();

                // Use Telegram theme color for the chart line
                const style = getComputedStyle(document.body);
                const lineColor = style.getPropertyValue('--tg-theme-button-color').trim() || '#007aff';
                const gridColor = style.getPropertyValue('--tg-theme-hint-color').trim() || '#8e8e93';

                dailyChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Plays',
                            data: values,
                            borderColor: lineColor,
                            backgroundColor: lineColor,
                            borderWidth: 2,
                            tension: 0.4,
                            pointRadius: 3,
                            pointBackgroundColor: style.getPropertyValue('--tg-theme-bg-color').trim(),
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: {
                                grid: { display: false },
                                ticks: { color: gridColor, font: { size: 10 } }
                            },
                            y: {
                                beginAtZero: true,
                                grid: { color: 'rgba(128,128,128,0.1)', borderDash: [5, 5] },
                                ticks: { color: gridColor, font: { size: 10 }, maxTicksLimit: 5 }
                            }
                        }
                    }
                });
            }

            let peakChart = null;
            async function loadPeakHours() {
                const data = await fetchAPI('peak-hours?days=7');
                if (!data) return;

                const ctx = document.getElementById('peakChart');
                const labels = Array.from({ length: 24 }, (_, i) => `${i}:00`);
                const values = data.data;

                if (peakChart) peakChart.destroy();

                const style = getComputedStyle(document.body);
                // Use a different color or same theme color
                const barColor = style.getPropertyValue('--tg-theme-button-color').trim() || '#007aff';
                const gridColor = style.getPropertyValue('--tg-theme-hint-color').trim() || '#8e8e93';

                peakChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Plays',
                            data: values,
                            backgroundColor: barColor,
                            borderRadius: 4,
                            barPercentage: 0.6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: {
                                grid: { display: false },
                                ticks: {
                                    color: gridColor,
                                    font: { size: 9 },
                                    maxTicksLimit: 12
                                }
                            },
                            y: {
                                grid: { color: 'rgba(128,128,128,0.1)', borderDash: [5, 5] },
                                ticks: { color: gridColor, font: { size: 10 }, maxTicksLimit: 5 }
                            }
                        }
                    }
                });
            }

            function renderList(containerId, data, titleKey, subtitleKey, valueKey, type) {
                const container = document.getElementById(containerId);
                if (!data || data.length === 0) {
                    container.innerHTML = '<div class="status-text">No data available</div>';
                    return;
                }

                container.innerHTML = data.map((item, index) => {
                    const rankClass = index < 3 ? `rank-${index + 1}` : '';
                    const title = item[titleKey] || 'Unknown';
                    // For users, show user_id as subtitle. For tracks, show duration. For chats, nothing or member count if available.
                    let subtitle = '';
                    if (titleKey === 'username' && item.user_id) subtitle = `ID: ${item.user_id}`;
                    if (titleKey === 'title' && item.duration) subtitle = item.duration;

                    // Image handling
                    let mediaHtml = '';
                    const showImage = type !== 'track'; // Hide images for tracks
                    const rowClass = showImage ? '' : 'no-image';

                    if (showImage) {
                        const shapeClass = type === 'track' ? 'rounded' : 'circle';
                        if (item.image) {
                            mediaHtml = `<img src="${item.image}" class="list-image ${shapeClass}" loading="lazy" onerror="this.style.display='none'">`;
                        } else {
                            const initials = title.substring(0, 1).toUpperCase();
                            // Generate a color based on the title string
                            const colors = ['#FF9500', '#FF3B30', '#5AC8FA', '#4CD964', '#5856D6', '#FF2D55'];
                            let hash = 0;
                            for (let i = 0; i < title.length; i++) hash = title.charCodeAt(i) + ((hash << 5) - hash);
                            const color = colors[Math.abs(hash) % colors.length];

                            mediaHtml = `<div class="list-placeholder ${shapeClass}" style="background-color: ${color}">${initials}</div>`;
                        }
                    }

                    return `
                <div class="list-row ${rowClass}">
                    <div class="rank-circle ${rankClass}">${index + 1}</div>
                    ${mediaHtml}
                    <div class="row-content">
                        <div class="row-title">${title}</div>
                        ${subtitle ? `<div class="row-subtitle">${subtitle}</div>` : ''}
                    </div>
                    <div class="row-value">${formatNumber(item[valueKey])}</div>
                </div>
                `;
                }).join('');
            }

            async function loadLists() {
                const [tracks, users, chats] = await Promise.all([
                    fetchAPI('top-tracks?limit=100'),
                    fetchAPI('top-users?limit=5'),
                    fetchAPI('top-chats?limit=5')
                ]);

                renderList('topTracksList', tracks, 'title', null, 'play_count', 'track');
                renderList('topUsersList', users, 'username', null, 'play_count', 'user');
                renderList('topChatsList', chats, 'chat_name', null, 'play_count', 'chat');
            }

            let platformChart = null;
            async function loadPlatformDistribution() {
                const response = await fetchAPI('platform-distribution');
                if (!response) return;

                const data = response.data;
                const ctx = document.getElementById('platformChart');

                // Filter out platforms with 0 plays
                const labels = [];
                const values = [];
                const colors = {
                    youtube: '#FF0000',
                    spotify: '#1DB954',
                    soundcloud: '#FF5500',
                    local: '#6c757d',
                    other: '#9b59b6'
                };
                const bgColors = [];

                for (const [platform, count] of Object.entries(data)) {
                    if (count > 0) {
                        labels.push(platform.charAt(0).toUpperCase() + platform.slice(1));
                        values.push(count);
                        bgColors.push(colors[platform] || '#cccccc');
                    }
                }

                if (platformChart) platformChart.destroy();

                const style = getComputedStyle(document.body);
                const textColor = style.getPropertyValue('--tg-theme-text-color').trim() || '#000000';

                platformChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: values,
                            backgroundColor: bgColors,
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'bottom',
                                labels: {
                                    color: textColor,
                                    font: { size: 12 },
                                    padding: 12
                                }
                            }
                        }
                    }
                });
            }

            // Network monitoring
            let networkRealtimeChart = null;
            let networkDataPoints = {
                upload: [],
                download: [],
                labels: []
            };
            const MAX_NETWORK_POINTS = 60; // 5 minutes at 5s intervals

            function initNetworkRealtimeChart() {
                const ctx = document.getElementById('networkRealtimeChart');
                const style = getComputedStyle(document.body);
                const textColor = style.getPropertyValue('--tg-theme-text-color').trim() || '#000000';
                const gridColor = style.getPropertyValue('--tg-theme-hint-color').trim() || '#8e8e93';

                networkRealtimeChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: networkDataPoints.labels,
                        datasets: [
                            {
                                label: 'Download',
                                data: networkDataPoints.download,
                                borderColor: '#1DB954',
                                backgroundColor: 'rgba(29, 185, 84, 0.1)',
                                borderWidth: 2,
                                tension: 0.4,
                                fill: true
                            },
                            {
                                label: 'Upload',
                                data: networkDataPoints.upload,
                                borderColor: '#0a84ff',
                                backgroundColor: 'rgba(10, 132, 255, 0.1)',
                                borderWidth: 2,
                                tension: 0.4,
                                fill: true
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: false,
                        plugins: {
                            legend: {
                                display: true,
                                labels: { color: textColor }
                            }
                        },
                        scales: {
                            x: {
                                display: false
                            },
                            y: {
                                beginAtZero: true,
                                grid: { color: 'rgba(128,128,128,0.1)' },
                                ticks: {
                                    color: gridColor,
                                    callback: function (value) {
                                        return (value / 1024 / 1024).toFixed(1) + ' MB/s';
                                    }
                                }
                            }
                        }
                    }
                });
            }

            function updateNetworkChart(uploadSpeed, downloadSpeed) {
                if (!networkRealtimeChart) {
                    initNetworkRealtimeChart();
                }

                // Add new data point
                networkDataPoints.upload.push(uploadSpeed);
                networkDataPoints.download.push(downloadSpeed);
                networkDataPoints.labels.push('');

                // Keep only last MAX_NETWORK_POINTS
                if (networkDataPoints.upload.length > MAX_NETWORK_POINTS) {
                    networkDataPoints.upload.shift();
                    networkDataPoints.download.shift();
                    networkDataPoints.labels.shift();
                }

                networkRealtimeChart.update();
            }

            let ws = null;
            let reconnectInterval = null;

            function connectWebSocket() {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.host}/ws`;

                ws = new WebSocket(wsUrl);

                ws.onopen = function () {
                    console.log('Connected to WebSocket');
                    if (reconnectInterval) {
                        clearInterval(reconnectInterval);
                        reconnectInterval = null;
                    }
                };

                ws.onmessage = function (event) {
                    try {
                        const message = JSON.parse(event.data);
                        if (message.type === 'overview') {
                            updateOverview(message.data);
                        }
                    } catch (e) {
                        console.error('Error parsing WS message:', e);
                    }
                };

                ws.onclose = function () {
                    console.log('WebSocket disconnected');
                    if (!reconnectInterval) {
                        reconnectInterval = setInterval(connectWebSocket, 3000);
                    }
                };

                ws.onerror = function (err) {
                    console.error('WebSocket error:', err);
                    ws.close();
                };
            }

            function formatUptime(seconds) {
                if (!seconds) return '-';
                const d = Math.floor(seconds / (3600 * 24));
                const h = Math.floor((seconds % (3600 * 24)) / 3600);
                const m = Math.floor((seconds % 3600) / 60);
                if (d > 0) return `${d}d ${h}h`;
                return `${h}h ${m}m`;
            }

            function updateOverview(data) {
                document.getElementById('totalUsers').textContent = formatNumber(data.total_users);
                document.getElementById('totalChats').textContent = formatNumber(data.total_chats);
                document.getElementById('totalPlays').textContent = formatNumber(data.total_plays);
                document.getElementById('activeCalls').textContent = formatNumber(data.active_calls);

                // Update System Stats
                if (data.system) {
                    document.getElementById('cpuBar').style.width = `${data.system.cpu}%`;
                    document.getElementById('cpuText').textContent = `${Math.round(data.system.cpu)}%`;

                    document.getElementById('ramBar').style.width = `${data.system.ram}%`;
                    document.getElementById('ramText').textContent = `${Math.round(data.system.ram)}%`;

                    document.getElementById('diskBar').style.width = `${data.system.disk}%`;
                    document.getElementById('diskText').textContent = `${Math.round(data.system.disk)}%`;

                    document.getElementById('uptimeText').textContent = formatUptime(data.system.uptime);

                    // Update network chart if data available
                    if (data.system.network) {
                        updateNetworkChart(data.system.network.upload_speed, data.system.network.download_speed);

                        // Update total usage
                        document.getElementById('totalUpload').textContent = formatBytes(data.system.network.total_sent);
                        document.getElementById('totalDownload').textContent = formatBytes(data.system.network.total_recv);
                    }
                }
            }

            async function loadAllData() {
                const fab = document.querySelector('.fab');
                fab.classList.add('spin');

                await Promise.all([
                    loadOverview(), // Initial load
                    loadChart(),
                    loadPeakHours(),
                    loadPlatformDistribution(),
                    loadLists()
                ]);

                fab.classList.remove('spin');
            }

            // Start
            function initApp() {
                if (tg) {
                    tg.ready();
                    tg.expand();
                }

                // Theme init with SVG icons
                const savedTheme = localStorage.getItem('theme');
                const btn = document.getElementById('themeBtn');

                if (savedTheme === 'dark') {
                    document.body.classList.add('dark-theme');
                    btn.innerHTML = sunIcon;
                } else if (savedTheme === 'light') {
                    document.body.classList.remove('dark-theme');
                    btn.innerHTML = moonIcon;
                } else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    document.body.classList.add('dark-theme');
                    btn.innerHTML = sunIcon;
                } else {
                    btn.innerHTML = moonIcon;
                }

                loadAllData();
                connectWebSocket(); // Start WS connection
            }

            initApp();
        </script>
</body>

</html>